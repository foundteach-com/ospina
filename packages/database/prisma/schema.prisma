generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  password      String
  name          String?
  role          UserRole        @default(USER)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Product {
  id                  String          @id @default(cuid())
  code                String          @unique
  name                String
  description         String?
  brand               String?
  measurementQuantity Decimal?
  measurementUnit     String?         // e.g., "ml", "kg", "unidad"
  
  purchasePrice       Decimal         @default(0) // Precio de compra sin IVA
  purchaseIvaPercent  Decimal         @default(19) // % de IVA compra (default 19%)
  
  utilityPercent      Decimal         @default(0) // % de utilidad
  
  salesIvaPercent     Decimal         @default(19) // % de IVA venta (default 19%)
  
  basePrice           Decimal         @default(0) // This will map to final selling price with IVA for compatibility
  sku                 String?         @unique // Keeping as optional for now to avoid migration pain, but will hide from UI

  categoryId          String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  category            Category?       @relation(fields: [categoryId], references: [id])
  purchaseItems       PurchaseItem[]
  saleItems           SaleItem[]
  clientPricing       ClientPricing[]
}

model Category {
  id       String    @id @default(cuid())
  name     String
  products Product[]
}

model Provider {
  id        String     @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  taxId     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  purchases Purchase[]
}

model Purchase {
  id              String         @id @default(cuid())
  providerId      String
  referenceNumber String // Factura, orden de compra, etc.
  date            DateTime
  total           Decimal
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  provider        Provider       @relation(fields: [providerId], references: [id])
  items           PurchaseItem[]
}

model PurchaseItem {
  id             String   @id @default(cuid())
  purchaseId     String
  productId      String
  quantity       Decimal
  purchasePrice  Decimal // Precio de compra en este momento espec√≠fico
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  purchase       Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id])
}

model Client {
  id            String          @id @default(cuid())
  name          String
  taxId         String          @unique // NIT or Cedula
  email         String?
  phone         String?
  address       String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  sales         Sale[]
  clientPricing ClientPricing[]
}

model Sale {
  id              String     @id @default(cuid())
  clientId        String
  referenceNumber String? // Optional receipt/invoice number
  date            DateTime
  total           Decimal
  status          SaleStatus @default(PENDING) // PENDING, COMPLETED, CANCELLED
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  client          Client     @relation(fields: [clientId], references: [id])
  items           SaleItem[]
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  productId String
  quantity  Int
  salePrice Decimal // Price at the moment of sale
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])
}

model ClientPricing {
  id        String   @id @default(cuid())
  clientId  String
  productId String
  price     Decimal? // Specific fixed price
  discount  Decimal? // Percentage discount
  markup    Decimal? // Percentage markup
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    Client   @relation(fields: [clientId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([clientId, productId])
}

model CashFlow {
  id            String       @id @default(cuid())
  date          DateTime
  receiptNumber String
  provider      String
  description   String
  type          CashFlowType
  amount        Decimal
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

enum UserRole {
  USER
  ADMIN
  EMPLOYEE
}

enum SaleStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum CashFlowType {
  INCOME
  EXPENSE
}
