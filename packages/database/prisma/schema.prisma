generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  password      String
  name          String?
  role          UserRole        @default(USER)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  sales         Sale[]
  clientPricing ClientPricing[]
}

model Product {
  id            String          @id @default(cuid())
  code          String          @unique
  name          String
  description   String
  basePrice     Decimal
  sku           String          @unique
  unit          String // e.g., "unidad", "kg", "litro", "caja"
  images        String[]
  categoryId    String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  category      Category?       @relation(fields: [categoryId], references: [id])
  purchaseItems PurchaseItem[]
  saleItems     SaleItem[]
  clientPricing ClientPricing[]
}

model Category {
  id       String    @id @default(cuid())
  name     String
  products Product[]
}

model Provider {
  id        String     @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  taxId     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  purchases Purchase[]
}

model Purchase {
  id              String         @id @default(cuid())
  providerId      String
  referenceNumber String // Factura, orden de compra, etc.
  date            DateTime
  total           Decimal
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  provider        Provider       @relation(fields: [providerId], references: [id])
  items           PurchaseItem[]
}

model PurchaseItem {
  id             String   @id @default(cuid())
  purchaseId     String
  productId      String
  quantity       Decimal
  purchasePrice  Decimal // Precio de compra en este momento específico
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  purchase       Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id])
}

model Sale {
  id              String     @id @default(cuid())
  userId          String // Cliente
  referenceNumber String? // Número de factura o recibo
  date            DateTime
  total           Decimal
  status          SaleStatus @default(PENDING)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  user            User       @relation(fields: [userId], references: [id])
  items           SaleItem[]
}

model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  productId String
  quantity  Decimal
  salePrice Decimal // Precio de venta en este momento específico
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])
}

model ClientPricing {
  id         String   @id @default(cuid())
  userId     String // Cliente
  productId  String
  priceType  String // "FIXED", "DISCOUNT", "MARKUP"
  value      Decimal // Precio fijo, % de descuento, o % de recargo
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
}

model CashFlow {
  id            String       @id @default(cuid())
  date          DateTime
  receiptNumber String
  provider      String
  description   String
  type          CashFlowType
  amount        Decimal
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

enum UserRole {
  USER
  ADMIN
  EMPLOYEE
}

enum SaleStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum CashFlowType {
  INCOME
  EXPENSE
}
