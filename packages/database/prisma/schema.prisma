generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatarUrl String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id                  String          @id @default(cuid())
  name                String
  description         String?
  sku                 String?         @unique
  categoryId          String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  basePrice           Decimal         @default(0)
  code                String          @unique
  brand               String?
  measurementQuantity Decimal?
  measurementUnit     String?
  purchaseIvaPercent  Decimal         @default(19)
  purchasePrice       Decimal         @default(0)
  salesIvaPercent     Decimal         @default(19)
  utilityPercent      Decimal         @default(0)
  imageUrl            String?
  isPublished         Boolean         @default(true)
  clientPricing       ClientPricing[]
  category            Category?       @relation(fields: [categoryId], references: [id])
  purchaseItems       PurchaseItem[]
  saleItems           SaleItem[]
  cotizacionItems     CotizacionItem[]
  internalMovements   InternalMovementItem[]
}

model Category {
  id       String    @id @default(cuid())
  name     String
  products Product[]
}

model Provider {
  id             String     @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  taxId          String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  city           String?
  commercialName String?
  purchases      Purchase[]
}

model Purchase {
  id              String         @id @default(cuid())
  providerId      String
  referenceNumber String
  date            DateTime
  total           Decimal
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  provider        Provider       @relation(fields: [providerId], references: [id])
  items           PurchaseItem[]
}

model PurchaseItem {
  id            String   @id @default(cuid())
  purchaseId    String
  productId     String
  quantity      Decimal
  purchasePrice Decimal
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  product       Product  @relation(fields: [productId], references: [id])
  purchase      Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
}

model Client {
  id            String          @id @default(cuid())
  name          String
  taxId         String          @unique
  email         String?
  phone         String?
  address       String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  city          String?
  clientPricing ClientPricing[]
  sales         Sale[]
}

model Sale {
  id              String     @id @default(cuid())
  referenceNumber String?
  date            DateTime
  total           Decimal
  status          SaleStatus @default(PENDING)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  clientId        String
  client          Client     @relation(fields: [clientId], references: [id])
  items           SaleItem[]
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  productId String
  quantity  Int
  salePrice Decimal
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
}

model ClientPricing {
  id        String   @id @default(cuid())
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clientId  String
  discount  Decimal?
  markup    Decimal?
  price     Decimal?
  client    Client   @relation(fields: [clientId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([clientId, productId])
}

model CashFlow {
  id            String       @id @default(cuid())
  date          DateTime
  receiptNumber String
  provider      String
  description   String
  type          CashFlowType
  amount        Decimal
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model CompanySettings {
  id              String   @id @default("singleton")
  companyName    String   @default("Ospina Admin")
  logoUrl        String?
  taxId          String?
  address        String?
  phone          String?
  email          String?
  primaryColor   String   @default("#2563eb")
  updatedAt      DateTime @updatedAt
}

enum UserRole {
  USER
  ADMIN
  EMPLOYEE
  VIEWER
}

enum SaleStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum CashFlowType {
  INCOME
  EXPENSE
}

enum CotizacionStatus {
  PENDIENTE
  APROBADA
  RECHAZADA
  VENCIDA
}

model Cotizacion {
  id              String            @id @default(cuid())
  numero          String            @unique
  clienteNombre   String
  clienteEmail    String?
  clienteTelefono String?
  fecha           DateTime
  validezDias     Int               @default(30)
  estado          CotizacionStatus  @default(PENDIENTE)
  notas           String?
  total           Decimal           @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  items           CotizacionItem[]
}

model CotizacionItem {
  id           String     @id @default(cuid())
  cotizacionId String
  productId    String
  quantity     Int
  unitPrice    Decimal
  cotizacion   Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id])
}

model InternalMovement {
  id          String               @id @default(cuid())
  date        DateTime
  type        InternalMovementType
  description String?
  total       Decimal              @default(0)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  items       InternalMovementItem[]
}

model InternalMovementItem {
  id                 String           @id @default(cuid())
  internalMovementId String
  productId          String
  quantity           Int
  unitPrice          Decimal?
  internalMovement   InternalMovement @relation(fields: [internalMovementId], references: [id], onDelete: Cascade)
  product            Product          @relation(fields: [productId], references: [id])
}

enum InternalMovementType {
  OWNER_WITHDRAWAL
  INTERNAL_USE
}
